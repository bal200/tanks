<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Bals game</title>
        <!-- use local Phaser Lib -->
        <!--<script src="phaser\build\phaser.js"></script> -->
        <!-- use CDN Phaser Lib -->
        <script src="//cdn.jsdelivr.net/phaser/2.6.1/phaser.min.js"></script>
        <script src="land.js"></script>
        <script src="player.js"></script>
        <script src="bullets.js"></script>
        <script src="mycam.js"></script>
    </head>
    <body>
    <script type="text/javascript">

var game = new Phaser.Game(900, 600, Phaser.WEBGL, 'Tanks');
var BasicGame = function(game) {};
BasicGame.Boot = function (game) {
    // nothing here
};

/********  Game Variable Declarations  *****************************************/
/*******************************************************************************/
var background;
var fullScreenButton;
var drawButton;
var drawMode = false;
var drawing = {
  lastPos:null,
  pointerId:null
}

var joystick, joystickBack;
var barrel, barrelBar;
var gameMode = 1; /* 1=Title Screen,  2=Game,  3=Win, 4=Loose */
var titlePage;

var level = {  /* Settings for this particular level in the game */
  x:0,  y:-1024,  /* world size */
  x2:2048, y2:1024,
  bgPercent : 0.15,  /** This percentage of the main screen Scale will be used as the Backgrounds scale.
                      ** Small values = a slow moving distant background */
  bgOffset:{      /** Because the background maths is calculated from the screen middle, you may need to */
    x:400, y:470  /** pull the background to the left and to the top. Tweak this to make sure the      */
  }               /** background neatly covers the whole world. */ 
}

BasicGame.Boot.prototype = 
{
  preload: function() {
    game.time.advancedTiming = true;
    game.load.image("titlepage", "assets/titlepage.png");
    game.load.image("fullscreen", "assets/fullscreen.png");
    game.load.image("background", "assets/background 1139x892.png");
    game.load.image("tank_right", "assets/tank_right.png");
    game.load.image("tank_left", "assets/tank_left.png");
    game.load.image("tank2_right", "assets/tank2_fromVector2.png");
    game.load.image("bullet", "assets/bullet.png");
    game.load.image("trace", "assets/trace.png");
    
    game.load.image("joystick", "assets/joystick.png");
    game.load.image("joypad", "assets/touchpad.png");
    game.load.image("barrel", "assets/barrel.png");
    game.load.image("barrelBar", "assets/barrelbar.png");

    game.load.image("pencil", "assets/pencil.png");
    game.load.spritesheet("boom", "assets/boom32wh12.png",32,32,12);
    
    game.load.tilemap('tilemap', 'assets/tilemap2.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.image('jungletileset', 'assets/jungletileset_32x32.png');
    
  },

  /**********  Create Function  ************************************************/
  /*****************************************************************************/
	create: function() 
	{
    game.scale.fullScreenScaleMode = Phaser.ScaleManager.RESIZE;
    //game.scale.scaleMode = Phaser.ScaleManager.RESIZE;

    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.physics.arcade.gravity.y = 200;
    
    /******* Parallax Background ********/
    background = game.add.sprite(0, 0, 'background');
    //background.fixedToCamera = true;
    //background.tileScale.set(0.5);
    //background.tint = 0x660000;

    /*****  Foreground (Land) **********/    
    createLand(this);

    /******* Player ********************/
    createPlayer(this);
    
    /************ Bullets *****************/
    createBullets(this);
    
    
    /****** Joystick ******************/
    /* not yet */

    /* button */
    this.button = game.add.group();
    this.button = game.add.button(0,0, 'joystick', fire, this,0,0,0);
    this.button.alpha = 0.4;
    this.button.scale.set(screenToWorldScale(0.6));
    this.button.anchor.set(0.5,0.5);
    
    //drawButton = game.add.group();
    drawButton = game.add.button(0,0, 'pencil', drawPress, this,0,0,0);
    drawButton.alpha = 0.6;
    //drawButton.scale.setTo(screenToWorldScale(0.1));
    drawButton.anchor.setTo(0.5,0.5);
    
    
    //if (joystick) game.world.bringToTop(joystick);
    /* Touch screen event handlers */
    game.input.onDown.add(pointerOnDown, this);
    game.input.onUp.add(pointerOnUp, this);
    
    titlePage = game.add.button(game.width/2,game.height/2, 'titlepage', titlePageStartPress, this,0,0,0);
    titlePage.anchor.set(0.5,0.5);
    
    fullScreenButton = game.add.button(0,0, 'fullscreen', fullScreenModePress, this,0,0,0);
    
    /****** My Camera *****************/
    createMyCam(this);
    

  },

  /**********  Update Function  ************************************************/
  /*****************************************************************************/
  update: function() 
  {
    
    /************ Player **************************************/
    updatePlayer(this);

    /************ Gun *****************************************/
    if (joystick) { if (joystick.method==1) {
      gun.angle += gun.angleVelocity;
      gun.power += gun.powerVelocity;
    }}
    /********** Foreground ************************************/
    updateLand(this);

    /********** Bullets ***************************************/
    updateBullets(this);
    
    /********** My Camera **************************************/
    updateMyCam(this);
   
   
    /********** Joystick ***************************************/
    /* position joystick in screen coords, rather than world coords. */
    if (joystick!=null) {
      var p = screenToWorld( { x:joystick.center.x, y:game.height-joystick.center.y } );
      joystick.x = p.x; joystick.y = p.y;
      joystick.scale.set(screenToWorldScale(1));
    }
    
    p = screenToWorld( { x:game.width-60, y:game.height-60 } );
    this.button.x = p.x; this.button.y = p.y;
    this.button.scale.set(screenToWorldScale(0.6));
    
    p = screenToWorld( { x:60, y:game.height-230 } );
    drawButton.x = p.x; drawButton.y = p.y;
    drawButton.scale.set(screenToWorldScale(0.12));
    
    p = screenToWorld( { x:(game.width/2), y:(game.height/2) } );
    titlePage.x = p.x; titlePage.y = p.y;
    titlePage.scale.set(screenToWorldScale(1.0));
    titlePage.bringToTop();
    
    p = screenToWorld( { x:10, y:10 } );
    fullScreenButton.x = p.x; fullScreenButton.y = p.y;
    fullScreenButton.scale.set(screenToWorldScale(1.0));

  }, 
  render: function()
  {
      game.debug.text(game.time.fps+"fps "
                      +"cam "+game.camera.x+","+game.camera.y+" "
                      +"myCam "+game.world.pivot.x.toFixed(0)+","+game.world.pivot.y.toFixed(0)+" "
                      +"scale "+worldScale.toFixed(2)+" "
                      +"player "+player.x.toFixed(0)+","+player.y.toFixed(0)
                      +" gun "+gun.angle.toFixed(1)+"a "+gun.power.toFixed(1)+"p"
                      +" scrn "+game.scale.width.toFixed(1)+","+game.scale.height.toFixed(1)+""
                      || '--', 2, 14, "#00ff00");   
  }
};

/***************************** Functions **********************************************/
function createJoystick() {
    joystick = game.add.group();
    joystick.method=3;
    joystick.long = 170; joystick.shrt = 40;
    joystick.center = {x:10,y:10}; /* the centre here means the segments centre, which is below left of the sprite */
    
    joystickBack = game.add.sprite(0,0, 'joypad');
    joystickBack.alpha = 0.4;
    joystickBack.anchor.set(0, 1.0);
    joystick.add( joystickBack );
    
    barrel = game.add.group();
    barrel.angle = gun.angle;
    barrelImg = game.add.sprite(0,0,'barrel'); 
    barrelImg.anchor.set(0.5, 1.0);
    barrel.add(barrelImg);
    
    barrelBar = game.add.sprite(0,0,'barrelBar');
    barrelBar.anchor.set(0.5, 1.0);
    barrel.add(barrelBar);
    
    joystick.add( barrel );
    updateJoypadBarrel(); /* set the joystick to reflect the current gun position */
}

function titlePageStartPress() {
  titlePage.destroy();
  gameMode = 2; /* Start Game */
  createJoystick();
  startEnemyLogic();

}
function drawPress() { /* the drawing pencil button pressed */
  if(drawMode==false)  {drawMode=true; drawButton.alpha=0.9}
  else  {drawMode=false; drawButton.alpha=0.6}
  turnTraceOff();
}
function drawOff(){
  if (drawMode==true) {drawMode=false; drawButton.alpha=0.6;}
}

function fullScreenModePress() {
  game.scale.startFullScreen();
}

function pointerOnDown(p) {

  var w=screenToWorld(p);
  var s=new Phaser.Point(p.x, p.y);
  if (joystick) {
    var centre=new Phaser.Point(joystick.center.x, game.height-joystick.center.y);
    var dist = Math.abs(s.distance(centre));
    var angle = Phaser.Math.radToDeg(Phaser.Math.angleBetweenPoints(centre, s));
  }
  //console.log("angle = "+angle);
  if (joystick && dist > joystick.shrt && dist < joystick.long && /* in the joysticks circle */
        angle > -90 && angle < 0) {
    /* theyve in our joystick */
    game.input.addMoveCallback(pointerOnMove, this);
    joystick.pointerId = p.id;
    joystick.start = s; /* store the starting press position, (in screen coords) */
    joystick.centre = centre;
    joystick.last = new Phaser.Point(s.x, s.y); /* the position it was last time */
    joystick.lastAngle = angle; /* the angle of this press */
    joystick.lastDist = centre.distance( s ); /* distance from the circles centre */
    turnTraceOn(); /* show the trace lines now were aiming the gun */
  }else {
    if (drawMode==true){ /* the drawing a base on the screen mode is on */
      drawing.lastPos=w;
      game.input.addMoveCallback(pointerOnMove, this);
      drawing.pointerId = p.id;
      bitmap.circle(w.x, w.y, 4.5, '#B020D0');
    }
  }
}
function pointerOnMove(p) {
  var w=screenToWorld(p);
  var s=new Phaser.Point(p.x, p.y);
  //console.log("Move "+p.x+","+p.y+" myWorld "+w.x.toFixed(0)+","+w.y.toFixed(0));
  if (p.id == joystick.pointerId) {
    var start=joystick.start;
    var centre=joystick.centre;
    var last = joystick.last;
    
    if (joystick.method==1) {
      var dist = start.distance(s);
      var deltaX = s.x - start.x;
      var deltaY = s.y - start.y;
      deltaX = (deltaX / 60) * player.speed;
      deltaY = (deltaY / 60) * player.speed;
      //this.player.body.velocity.x = deltaX;
      //this.player.body.velocity.y = deltaY;
      this.gun.angleVelocity += deltaX/4000;
      this.gun.powerVelocity += -deltaY/1000;
    }
    if (joystick.method==2) {
      var lastDeltaX = s.x - last.x;
      var lastDeltaY = s.y - last.y;
      gun.angle += lastDeltaX * 0.50;
      gun.power -= lastDeltaY * 2;
    }
    if (joystick.method==3) {
      var angle = Phaser.Math.radToDeg(Phaser.Math.angleBetweenPoints(centre, s));
      var dist = centre.distance( s );
      
      if (dist > 20)
        gun.angle += (angle - joystick.lastAngle);
      gun.power += (dist - joystick.lastDist) *6;
      joystick.lastAngle = angle;      
      joystick.lastDist = dist;
    }
    //Phaser.Math.wrapAngle();
    //gun.angle = Phaser.math.clamp(gun.angle, -135, 135);
    if (gun.angle>135) gun.angle = 135;
    if (gun.angle<-135) gun.angle = -135;
    gun.power = Phaser.Math.clamp(gun.power, 90, 850);
    
    /* Draw the joypads gun-barrel graphic */
    updateJoypadBarrel();
    
    joystick.last = s;
  }
  
  if (p.id == drawing.pointerId) {
    if (drawing.lastPos!=null){
      if (w.distance( drawing.lastPos ) > 10) {
        bitmap.circle(w.x, w.y, 4.5, '#B020D0');
        bitmap.line(drawing.lastPos.x,drawing.lastPos.y, w.x, w.y, '#B020D0',  10);
        bitmap.update();
        bitmap.dirty = true;
          
        drawing.lastPos.x=w.x; drawing.lastPos.y=w.y;
      }
    }
    
  }
  
}

function pointerOnUp(p) {
  var w=screenToWorld(p);
  //console.log("up "+p.x+","+p.y+" myWorld "+w.x.toFixed(0)+","+w.y.toFixed(0));
  if (joystick){ if (p.id == joystick.pointerId) {
    game.input.deleteMoveCallback(pointerOnMove, this);
    joystick.pointerId = null;
    //this.player.body.velocity.x = 0;
    //this.player.body.velocity.y = 0;
    //this.gun.angleVelocity =0;
    //this.gun.powerVelocity =0;
  }}
  if (p.id == drawing.pointerId) {
    drawing.pointerId = null;
    game.input.deleteMoveCallback(pointerOnMove, this);
  }
}

function updateJoypadBarrel() {
      /* Draw the joypads gun-barrel graphic */
      barrel.angle = gun.angle;
      var vec = angleToVector( gun.angle );
      barrel.x = vec.x * (joystick.shrt );
      barrel.y = vec.y * (joystick.shrt );
      barrelBar.length = ((gun.power-90)/(850-90) * 130);
      barrelBar.crop(new Phaser.Rectangle(0,  130-barrelBar.length,
                                          15, 130 ));
}

/** Convert coordinates on the screen, like touches, into their position if they were in the game world
 ** Takes into account the camera position and scaling too */
function screenToWorld(s) {
  w = new Phaser.Point();
  w.x = ((s.x / worldScale) + game.world.pivot.x);
  w.y = ((s.y / worldScale) + game.world.pivot.y);
  return w;
}
function worldToScreen(w) {
  s = new Phaser.Point();
  s.x = ((w.x - game.world.pivot.x) * worldScale);
  s.y = ((w.y - game.world.pivot.y) * worldScale);
  return s;
}
function screenToWorldScale(s) {
  return (1/worldScale) * s;
}



game.state.add('Boot', BasicGame.Boot);
game.state.start('Boot');


 

    </script>
    </body>
</html>